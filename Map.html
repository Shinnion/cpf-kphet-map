<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPF Market Map ‚Äî ‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --accent:#1558d6;--ok:#0f9d6e;--danger:#c0392b;--warn:#c97b0a;
  --surface:#fff;--s2:#f7f8fa;--bd:#e2e5ea;
  --text:#1a1f2e;--t2:#5a6275;--t3:#9aa0ae;
  --shadow:0 2px 12px rgba(0,0,0,.10);--r:8px;
}
html,body{height:100%;overflow:hidden;font-family:'Sarabun',sans-serif;color:var(--text);background:#eef1f7;display:flex;flex-direction:column}

/* TOPBAR */
#topbar{height:52px;display:flex;align-items:center;gap:10px;padding:0 14px;background:var(--surface);border-bottom:1px solid var(--bd);box-shadow:0 1px 6px rgba(0,0,0,.07);position:relative;z-index:1001;flex-shrink:0}
.logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:15px;color:var(--accent);white-space:nowrap}
.logo svg{width:28px;height:28px}
.logo span{font-family:'Space Mono',monospace;font-size:13px;letter-spacing:-.5px}
.logo small{font-family:'Sarabun',sans-serif;font-size:10px;color:var(--t3);font-weight:400;display:block;margin-top:-2px}
#search-wrap{flex:1;max-width:320px;position:relative}
#search{width:100%;height:34px;border:1.5px solid var(--bd);border-radius:20px;padding:0 34px 0 14px;font-size:13px;font-family:'Sarabun',sans-serif;outline:none;background:var(--s2);transition:border .2s}
#search:focus{border-color:var(--accent);background:#fff}
.search-icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--t3);pointer-events:none}
.stats{display:flex;gap:8px;align-items:center;margin-left:4px}
.stat-chip{font-size:11px;color:var(--t2);white-space:nowrap;background:var(--s2);border:1px solid var(--bd);border-radius:12px;padding:3px 10px;font-family:'Space Mono',monospace}
.stat-chip strong{color:var(--text)}
.spacer{flex:1}
#btn-add{height:34px;padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:20px;font-size:13px;font-family:'Sarabun',sans-serif;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background .15s,transform .1s;white-space:nowrap}
#btn-add:hover{background:#1148b8}
#btn-add:active{transform:scale(.97)}
.btn-icon{width:28px;height:28px;border:none;background:var(--s2);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--t2);transition:background .15s,color .15s;flex-shrink:0}
.btn-icon:hover{background:var(--bd);color:var(--text)}

/* MAIN */
#main{display:flex;flex:1;height:calc(100vh - 52px);overflow:hidden}

/* SIDEBAR */
#sidebar{width:240px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow:hidden;transition:width .25s ease;z-index:10}
#sidebar.collapsed{width:0;border:none}
.io-bar{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid var(--bd);flex-shrink:0}
.sidebar-section{padding:12px;border-bottom:1px solid var(--bd);flex-shrink:0}
.sidebar-label{font-size:10px;font-weight:700;color:var(--t3);letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-item{display:flex;align-items:center;gap:8px;padding:5px 6px;border-radius:6px;cursor:pointer;transition:background .15s;font-size:13px}
.filter-item:hover{background:var(--s2)}
.filter-item input[type=checkbox]{width:14px;height:14px;cursor:pointer;accent-color:var(--accent);flex-shrink:0}
.ch-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.filter-count{margin-left:auto;font-size:11px;font-family:'Space Mono',monospace;color:var(--t3)}
#shop-list{flex:1;overflow-y:auto;padding:8px}
.shop-item{padding:8px 10px;border-radius:8px;cursor:pointer;margin-bottom:4px;border:1.5px solid transparent;transition:border .15s,background .15s}
.shop-item:hover{background:var(--s2);border-color:var(--bd)}
.shop-item.active{background:#edf2ff;border-color:var(--accent)}
.shop-item-name{font-size:13px;font-weight:600;color:var(--text)}
.shop-item-meta{font-size:11px;color:var(--t2);margin-top:2px;display:flex;gap:6px;align-items:center}
.ch-badge{font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;color:#fff;white-space:nowrap}
.shop-item-addr{font-size:11px;color:var(--t3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.empty-state{text-align:center;padding:40px 20px;color:var(--t3)}
.empty-state p{font-size:13px;margin-top:10px}

/* MAP */
#map-area{flex:1;position:relative;overflow:hidden}
#map{width:100%;height:100%}

/* Leaflet popup */
.leaflet-popup-content-wrapper{border-radius:12px!important;box-shadow:0 4px 20px rgba(0,0,0,.18)!important;font-family:'Sarabun',sans-serif!important;padding:0!important;overflow:hidden}
.leaflet-popup-content{margin:0!important;width:220px!important}
.popup-inner{padding:14px 16px}
.popup-name{font-size:14px;font-weight:700;color:var(--text);margin-bottom:6px}
.popup-meta{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.popup-addr{font-size:12px;color:var(--t2)}
.popup-actions{display:flex;gap:6px;padding:10px 16px;border-top:1px solid var(--bd);background:var(--s2)}
.popup-btn{flex:1;height:28px;border:none;border-radius:6px;font-size:12px;font-family:'Sarabun',sans-serif;font-weight:600;cursor:pointer;transition:background .15s}
.popup-btn-edit{background:var(--accent);color:#fff}.popup-btn-edit:hover{background:#1148b8}
.popup-btn-del{background:#fdecea;color:var(--danger)}.popup-btn-del:hover{background:#f9d0cc}

/* Custom pin */
.custom-pin{width:32px;height:44px;position:relative;cursor:pointer}
.custom-pin .pin-body{width:28px;height:34px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid rgba(255,255,255,.95);box-shadow:0 3px 12px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;transition:transform .15s}
.custom-pin:hover .pin-body,.custom-pin.sel .pin-body{transform:rotate(-45deg) scale(1.2)}
.custom-pin .pin-icon{transform:rotate(45deg);font-size:13px;line-height:1}
.custom-pin .pin-tip{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:10px;height:5px;background:rgba(0,0,0,.22);border-radius:50%}

/* Pick mode ‚Äî force crosshair on every Leaflet layer */
#map.pick-mode,
#map.pick-mode .leaflet-container,
#map.pick-mode .leaflet-pane,
#map.pick-mode .leaflet-tile-pane,
#map.pick-mode .leaflet-overlay-pane,
#map.pick-mode .leaflet-marker-pane,
#map.pick-mode .leaflet-interactive,
#map.pick-mode .leaflet-grab,
#map.pick-mode .leaflet-dragging{cursor:crosshair!important}
#pick-banner{position:absolute;top:16px;left:50%;transform:translateX(-50%);background:#1a1f2e;color:#fff;padding:10px 20px;border-radius:30px;font-size:13px;z-index:1000;display:none;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,.35);pointer-events:none}
#pick-banner.active{display:flex;pointer-events:all}
#pick-cancel{background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:20px;padding:4px 12px;font-size:12px;cursor:pointer;font-family:'Sarabun',sans-serif}
#pick-cancel:hover{background:rgba(255,255,255,.25)}

/* Tile switcher */
.tile-switcher{position:absolute;top:14px;right:14px;background:rgba(255,255,255,.96);border:1px solid var(--bd);border-radius:10px;padding:7px 9px;box-shadow:var(--shadow);z-index:999;display:flex;gap:5px}
.tile-btn{height:26px;padding:0 10px;border:1.5px solid var(--bd);border-radius:6px;font-size:11px;font-family:'Sarabun',sans-serif;cursor:pointer;background:#fff;color:var(--t2);transition:all .15s;font-weight:600}
.tile-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Legend */
.map-legend{position:absolute;bottom:28px;left:14px;background:rgba(255,255,255,.96);border:1px solid var(--bd);border-radius:10px;padding:10px 12px;box-shadow:var(--shadow);z-index:999;font-size:11px}
.legend-title{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
.legend-row{display:flex;align-items:center;gap:7px;margin-bottom:4px;color:var(--t2)}

/* DETAIL PANEL */
#detail-panel{width:0;overflow:hidden;background:var(--surface);border-left:1px solid var(--bd);flex-shrink:0;transition:width .25s ease;display:flex;flex-direction:column;z-index:10}
#detail-panel.open{width:300px}
.panel-header{padding:14px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px;flex-shrink:0}
.panel-close{width:28px;height:28px;border:none;background:none;cursor:pointer;color:var(--t2);border-radius:6px;display:flex;align-items:center;justify-content:center;transition:background .15s;margin-left:auto;flex-shrink:0}
.panel-close:hover{background:var(--s2)}
.panel-title{font-size:15px;font-weight:700;color:var(--text);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.panel-body{padding:16px;overflow-y:auto;flex:1}
.detail-field{margin-bottom:14px}
.detail-field label{display:block;font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px}
.detail-field p{font-size:13px;color:var(--text)}
.products-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.product-tag{background:var(--s2);border:1px solid var(--bd);border-radius:20px;padding:3px 10px;font-size:12px;color:var(--t2)}
.detail-actions{padding:14px 16px;border-top:1px solid var(--bd);display:flex;gap:8px;flex-shrink:0}

/* BUTTONS */
.btn{height:34px;padding:0 14px;border-radius:8px;font-size:13px;font-family:'Sarabun',sans-serif;font-weight:600;cursor:pointer;border:none;display:flex;align-items:center;gap:6px;transition:background .15s,transform .1s}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#1148b8}
.btn-danger{background:#fdecea;color:var(--danger)}.btn-danger:hover{background:#f9d0cc}
.btn-ghost{background:var(--s2);color:var(--t2);border:1px solid var(--bd)}.btn-ghost:hover{background:var(--bd)}
.btn-sm{height:28px;font-size:11px;padding:0 10px}
.btn-full{flex:1;justify-content:center;height:40px;font-size:14px}

/* FORM DRAWER */
#form-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1200;opacity:0;pointer-events:none;transition:opacity .2s}
#form-overlay.open{opacity:1;pointer-events:all}
#form-drawer{position:fixed;top:0;right:-460px;width:440px;height:100%;background:var(--surface);box-shadow:-4px 0 24px rgba(0,0,0,.15);z-index:1201;display:flex;flex-direction:column;transition:right .25s cubic-bezier(.4,0,.2,1)}
#form-drawer.open{right:0}
.drawer-header{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:12px;flex-shrink:0}
.drawer-title{font-size:16px;font-weight:700}
.drawer-close{margin-left:auto;width:30px;height:30px;border:none;background:none;cursor:pointer;color:var(--t2);border-radius:6px;display:flex;align-items:center;justify-content:center}
.drawer-close:hover{background:var(--s2)}
.drawer-body{flex:1;overflow-y:auto;padding:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:700;color:var(--t2);margin-bottom:6px}
.req{color:var(--danger)}
.form-input,.form-select,.form-textarea{width:100%;padding:9px 12px;border:1.5px solid var(--bd);border-radius:var(--r);font-size:14px;font-family:'Sarabun',sans-serif;color:var(--text);background:var(--s2);outline:none;transition:border .2s,background .2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);background:#fff}
.form-textarea{resize:vertical;min-height:80px}
.form-row{display:flex;gap:12px}
.form-row .form-group{flex:1}
.form-section-title{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px;padding-top:4px}
.checkbox-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.cb-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:6px;border:1.5px solid var(--bd);cursor:pointer;font-size:13px;transition:border .15s,background .15s}
.cb-item:hover{border-color:var(--accent);background:#edf2ff}
.cb-item input{width:14px;height:14px;cursor:pointer;accent-color:var(--accent);flex-shrink:0}
.coords-display{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);background:#edf2ff;border-radius:6px;padding:6px 10px;margin-top:8px}
.drawer-footer{padding:16px 20px;border-top:1px solid var(--bd);display:flex;gap:10px;flex-shrink:0}

/* RATING */
.stars{display:flex;gap:4px;margin-top:4px}
.star{font-size:22px;cursor:pointer;color:var(--bd);transition:color .1s;line-height:1}
.star.on{color:#f39c12}

/* SEARCH DROPDOWN */
#search-dropdown{position:absolute;top:38px;left:0;right:0;background:var(--surface);border:1.5px solid var(--bd);border-radius:10px;box-shadow:var(--shadow);z-index:1300;overflow:hidden;display:none}
#search-dropdown.show{display:block}
.drop-item{padding:9px 14px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:10px;transition:background .1s}
.drop-item:hover{background:var(--s2)}
.drop-ch{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* TOAST */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(60px);background:#1a1f2e;color:#fff;padding:10px 20px;border-radius:30px;font-size:13px;z-index:9999;transition:transform .3s;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.3)}
#toast.show{transform:translateX(-50%) translateY(0)}

/* Confirm dialog */
#confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9990;display:none;align-items:center;justify-content:center}
#confirm-overlay.show{display:flex}
#confirm-box{background:#fff;border-radius:14px;padding:24px;width:300px;box-shadow:0 8px 40px rgba(0,0,0,.25);text-align:center}
#confirm-box h3{font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px}
#confirm-box p{font-size:13px;color:var(--t2);margin-bottom:20px}
#confirm-btns{display:flex;gap:10px}
#confirm-btns button{flex:1;height:38px;border:none;border-radius:8px;font-size:14px;font-family:'Sarabun',sans-serif;font-weight:600;cursor:pointer;transition:background .15s}
#confirm-ok{background:var(--danger);color:#fff}
#confirm-ok:hover{background:#a93226}
#confirm-cancel{background:var(--s2);color:var(--t2);border:1px solid var(--bd)}
#confirm-cancel:hover{background:var(--bd)}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="logo">
    <svg viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#1558d6"/>
      <path d="M16 6C11.6 6 8 9.6 8 14c0 6 8 16 8 16s8-10 8-16c0-4.4-3.6-8-8-8z" fill="white"/>
      <circle cx="16" cy="14" r="3" fill="#1558d6"/>
    </svg>
    <div>
      <span>CPF MAP</span>
      <small>‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£ ¬∑ Market Inspection</small>
    </div>
  </div>
  <div id="search-wrap">
    <input id="search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤..." autocomplete="off">
    <span class="search-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></span>
    <div id="search-dropdown"></div>
  </div>
  <div class="stats">
    <div class="stat-chip">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong id="stat-total">0</strong></div>
    <div class="stat-chip">‡πÅ‡∏™‡∏î‡∏á <strong id="stat-showing">0</strong></div>
    <div class="stat-chip">üìç <strong id="stat-pinned">0</strong></div>
  </div>
  <div class="spacer"></div>
  <button class="btn-icon" title="Toggle sidebar" onclick="toggleSidebar()">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <button class="btn-icon" title="Export CSV" onclick="exportCSV()">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
  </button>
  <button class="btn-icon" title="Import CSV" onclick="document.getElementById('csv-input').click()">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
  </button>
  <button class="btn-icon" title="Share" onclick="shareApp()">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
  </button>
  <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="importCSV(event)">
  <button id="btn-add" onclick="openForm()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
  </button>
</div>

<!-- MAIN -->
<div id="main">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="io-bar">
      <button class="btn btn-ghost btn-sm" style="flex:1;justify-content:center" onclick="exportCSV()">üì• Export</button>
      <button class="btn btn-ghost btn-sm" style="flex:1;justify-content:center" onclick="document.getElementById('csv-input').click()">üì§ Import</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div>
      <div class="filter-group" id="channel-filters"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</div>
      <div class="filter-group" id="product-filters"></div>
    </div>
    <div class="sidebar-section" style="border:none;flex:1;overflow:hidden;display:flex;flex-direction:column;padding-bottom:0">
      <div class="sidebar-label">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      <div id="shop-list" style="flex:1;overflow-y:auto;padding-bottom:8px"></div>
    </div>
  </div>

  <!-- MAP AREA -->
  <div id="map-area">
    <div id="map"></div>

    <div id="pick-banner">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/></svg>
      ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      <button id="pick-cancel" onclick="cancelPick()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <div class="tile-switcher">
      <button class="tile-btn active" onclick="setTile('osm',this)">üó∫ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
      <button class="tile-btn" onclick="setTile('satellite',this)">üõ∞ ‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</button>
      <button class="tile-btn" onclick="setTile('topo',this)">‚õ∞ Topo</button>
    </div>

    <div class="map-legend">
      <div class="legend-title">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</div>
      <div id="legend-rows"></div>
    </div>
  </div>

  <!-- DETAIL PANEL -->
  <div id="detail-panel">
    <div class="panel-header">
      <div class="panel-title" id="detail-name">‚Äî</div>
      <button class="panel-close" onclick="closeDetail()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="panel-body" id="detail-body"></div>
    <div class="detail-actions">
      <button class="btn btn-primary" onclick="editCurrent()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button class="btn btn-danger" onclick="deleteCurrent()">üóë ‡∏•‡∏ö</button>
    </div>
  </div>

</div>

<!-- FORM DRAWER -->
<div id="form-overlay" onclick="closeForm()"></div>
<div id="form-drawer">
  <div class="drawer-header">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/></svg>
    <div class="drawer-title" id="form-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
    <button class="drawer-close" onclick="closeForm()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="drawer-body">
    <div class="form-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
    <div class="form-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ <span class="req">*</span></label>
      <input class="form-input" id="f-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏°‡∏ä‡∏≤‡∏¢" type="text">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á <span class="req">*</span></label>
        <select class="form-select" id="f-channel">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</option>
          <option value="‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î">‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î</option>
          <option value="‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡πá‡∏≠‡∏õ">‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡πá‡∏≠‡∏õ</option>
          <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
          <option value="‡πÅ‡∏ú‡∏á‡∏£‡∏¥‡∏°‡∏ñ‡∏ô‡∏ô">‡πÅ‡∏ú‡∏á‡∏£‡∏¥‡∏°‡∏ñ‡∏ô‡∏ô</option>
          <option value="‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</option>
        </select>
      </div>
      <div class="form-group">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <select class="form-select" id="f-type">
          <option value="retail">‡∏õ‡∏•‡∏µ‡∏Å</option>
          <option value="wholesale">‡∏™‡πà‡∏á</option>
          <option value="horeca">HoReCa</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÇ‡∏ã‡∏ô</label>
      <input class="form-input" id="f-address" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏• ‡∏ã.3" type="text">
    </div>
    <div class="form-group">
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
      <input class="form-input" id="f-phone" placeholder="08x-xxx-xxxx" type="tel">
    </div>
    <div class="form-section-title" style="margin-top:18px">‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå CPF ‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</div>
    <div class="checkbox-grid" id="product-checkboxes"></div>
    <div class="form-section-title" style="margin-top:18px">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à</div>
    <div class="stars" id="rating-stars"></div>
    <div style="font-size:11px;color:var(--t3);margin-top:4px" id="rating-label">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="form-group" style="margin-top:18px">
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea class="form-textarea" id="f-note" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
    </div>
    <div class="form-section-title" style="margin-top:4px">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
    <button class="btn btn-ghost" style="width:100%;justify-content:center" onclick="startPick()">
      üìç ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    </button>
    <div style="font-size:11px;color:var(--t3);margin-top:6px;display:flex;align-items:center;gap:5px">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏à‡∏∞‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    </div>
    <div class="coords-display" id="coords-display" style="display:none"></div>
  </div>
  <div class="drawer-footer">
    <button class="btn btn-ghost btn-full" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <button class="btn btn-primary btn-full" onclick="saveShop()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>
</div>

<div id="confirm-overlay">
  <div id="confirm-box">
    <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
    <p id="confirm-msg">‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà?</p>
    <div id="confirm-btns">
      <button id="confirm-cancel" onclick="confirmClose()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="confirm-ok" onclick="confirmOk()">üóë ‡∏•‡∏ö</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHANNELS = {
  '‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î':    {color:'#0f9d6e', icon:'üè™'},
  '‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡πá‡∏≠‡∏õ':  {color:'#1558d6', icon:'üõí'},
  '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£': {color:'#e67e22', icon:'üçΩÔ∏è'},
  '‡πÅ‡∏ú‡∏á‡∏£‡∏¥‡∏°‡∏ñ‡∏ô‡∏ô': {color:'#8e44ad', icon:'üèóÔ∏è'},
  '‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï':{color:'#c0392b', icon:'üè≠'},
};
const PRODUCTS = ['‡πÑ‡∏Å‡πà‡∏™‡∏î','‡∏´‡∏°‡∏π‡∏™‡∏î','‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å','‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô','‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà','‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á','‡∏õ‡∏•‡∏≤','‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ß','‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
const STORAGE_KEY = 'cpf_shops_v4';

// Kamphaeng Phet city centre
const KPP = [16.4827, 99.5220];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let shops = [], filters = {channels:new Set(Object.keys(CHANNELS)), products:new Set(PRODUCTS)};
let selectedId=null, editId=null, pickMode=false, rating=0;
let leafMap, markers={};

const TILES = {
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'¬© Esri World Imagery',maxZoom:19}),
  topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{
    attribution:'¬© OpenTopoMap',maxZoom:17}),
};

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save(){
  try{localStorage.setItem(STORAGE_KEY,JSON.stringify(shops));}catch(e){}
  if(window.storage) window.storage.set('cpf_v4',JSON.stringify(shops),true).catch(()=>{});
}
async function load(){
  const local=localStorage.getItem(STORAGE_KEY);
  if(local){try{shops=JSON.parse(local);return;}catch(e){}}
  if(window.storage){try{const r=await window.storage.get('cpf_v4',true);if(r){shops=JSON.parse(r.value);return;}}catch(e){}}
  shops=getSampleData();
}
function getSampleData(){
  return [
    {id:'1',name:'‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏• 1',   channel:'‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î',    type:'retail',  address:'‡∏ñ.‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô',         phone:'055-711-xxx',products:['‡πÑ‡∏Å‡πà‡∏™‡∏î','‡∏´‡∏°‡∏π‡∏™‡∏î','‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà'],             rating:5,note:'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ ‡∏¢‡∏≠‡∏î‡∏î‡∏µ',lat:16.4794,lng:99.5221,pinned:true},
    {id:'2',name:'‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡πá‡∏≠‡∏õ ‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô',channel:'‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡πá‡∏≠‡∏õ', type:'retail',  address:'‡∏ñ.‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô',         phone:'055-712-xxx',products:['‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å','‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô','‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á'],rating:4,note:'',lat:16.4810,lng:99.5248,pinned:true},
    {id:'3',name:'‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏ß',    channel:'‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£',type:'horeca',  address:'‡∏ã.5 ‡∏ñ.‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô',     phone:'',           products:['‡πÑ‡∏Å‡πà‡∏™‡∏î','‡∏´‡∏°‡∏π‡∏™‡∏î'],                     rating:3,note:'‡∏™‡∏±‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå',lat:16.4851,lng:99.5196,pinned:false},
    {id:'4',name:'‡πÅ‡∏ú‡∏á‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢',       channel:'‡πÅ‡∏ú‡∏á‡∏£‡∏¥‡∏°‡∏ñ‡∏ô‡∏ô',type:'retail',  address:'‡∏ñ.‡πÄ‡∏ó‡∏®‡∏≤',              phone:'082-xxx-xxxx',products:['‡πÑ‡∏Å‡πà‡∏™‡∏î'],                            rating:4,note:'',lat:16.4775,lng:99.5188,pinned:false},
    {id:'5',name:'‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ KPP',  channel:'‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï',type:'wholesale',address:'‡∏ñ.‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£-‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',phone:'055-720-xxx',products:['‡πÑ‡∏Å‡πà‡∏™‡∏î','‡∏´‡∏°‡∏π‡∏™‡∏î','‡∏õ‡∏•‡∏≤','‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ß'],   rating:5,note:'‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏ç‡πà',lat:16.4870,lng:99.5270,pinned:true},
    {id:'6',name:'‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≤‡∏£‡πå‡∏ó‡∏£‡∏¥‡∏°‡∏ó‡∏≤‡∏á',   channel:'‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡πá‡∏≠‡∏õ', type:'retail',  address:'‡∏ñ.‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå‡∏ß‡∏¥‡∏ñ‡∏µ',       phone:'',           products:['‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å','‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà'],                  rating:2,note:'‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≥ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°',lat:16.4833,lng:99.5298,pinned:false},
    {id:'7',name:'‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏°‡∏≤‡∏•‡∏µ',    channel:'‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£',type:'horeca',  address:'‡πÉ‡∏Å‡∏•‡πâ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•',      phone:'089-xxx-xxxx',products:['‡πÑ‡∏Å‡πà‡∏™‡∏î','‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà','‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô'],   rating:4,note:'',lat:16.4763,lng:99.5260,pinned:false},
    {id:'8',name:'‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î ‡∏®‡∏∏‡∏Å‡∏£‡πå',     channel:'‡πÅ‡∏ú‡∏á‡∏£‡∏¥‡∏°‡∏ñ‡∏ô‡∏ô',type:'retail',  address:'‡∏ñ.‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£-‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',phone:'',           products:['‡∏´‡∏°‡∏π‡∏™‡∏î','‡πÑ‡∏Å‡πà‡∏™‡∏î'],                    rating:3,note:'‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå',lat:16.4895,lng:99.5155,pinned:false},
  ];
}

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap(){
  leafMap=L.map('map',{center:KPP,zoom:14,zoomControl:true});
  TILES.osm.addTo(leafMap);
  leafMap.fitBounds([[16.460,99.495],[16.505,99.555]]);

  leafMap.on('click',function(e){
    if(!pickMode) return;
    const {lat,lng}=e.latlng;
    window._pickCoords={lat,lng};
    document.getElementById('coords-display').style.display='block';
    document.getElementById('coords-display').textContent=`${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    cancelPick();
    showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  });
}

function setTile(name,btn){
  Object.values(TILES).forEach(t=>{if(leafMap.hasLayer(t))leafMap.removeLayer(t);});
  TILES[name].addTo(leafMap);
  document.querySelectorAll('.tile-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

// ‚îÄ‚îÄ ICONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeIcon(shop){
  const cfg=CHANNELS[shop.channel]||{color:'#999',icon:'üìç'};
  const sel=selectedId===shop.id;
  return L.divIcon({
    html:`<div class="custom-pin${sel?' sel':''}">
      <div class="pin-body" style="background:${cfg.color}">
        <span class="pin-icon">${cfg.icon}</span>
      </div>
      <div class="pin-tip"></div>
    </div>`,
    className:'',iconSize:[32,44],iconAnchor:[16,44],popupAnchor:[0,-46]
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getVisible(){
  const q=document.getElementById('search').value.trim().toLowerCase();
  return shops.filter(s=>{
    if(!filters.channels.has(s.channel)) return false;
    if(s.products&&s.products.length&&!s.products.some(p=>filters.products.has(p))) return false;
    if(q&&!s.name.toLowerCase().includes(q)&&!(s.address||'').toLowerCase().includes(q)&&!(s.channel||'').toLowerCase().includes(q)) return false;
    return true;
  });
}

function render(){
  const visible=getVisible();
  const visIds=new Set(visible.map(s=>s.id));
  document.getElementById('stat-total').textContent=shops.length;
  document.getElementById('stat-showing').textContent=visible.length;
  document.getElementById('stat-pinned').textContent=shops.filter(s=>s.pinned).length;
  Object.keys(CHANNELS).forEach(ch=>{
    const el=document.getElementById('fc-'+ch.replace(/[^\w]/g,'_'));
    if(el) el.textContent=shops.filter(s=>s.channel===ch).length;
  });

  // Sidebar list
  const listEl=document.getElementById('shop-list');
  if(!visible.length){
    listEl.innerHTML=`<div class="empty-state"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</p></div>`;
  } else {
    listEl.innerHTML=visible.map(s=>{
      const cfg=CHANNELS[s.channel]||{color:'#999'};
      return `<div class="shop-item${selectedId===s.id?' active':''}" onclick="selectShop('${s.id}')">
        <div class="shop-item-name">${s.name}${s.pinned?' üìç':''}</div>
        <div class="shop-item-meta"><span class="ch-badge" style="background:${cfg.color}">${s.channel||'?'}</span>${s.rating?'‚≠ê'.repeat(s.rating):''}</div>
        <div class="shop-item-addr">${s.address||'‚Äî'}</div>
      </div>`;
    }).join('');
  }

  // Map markers
  Object.keys(markers).forEach(id=>{
    if(!visIds.has(id)){leafMap.removeLayer(markers[id]);delete markers[id];}
  });
  visible.forEach(s=>{
    if(s.lat==null||s.lng==null) return;
    if(markers[s.id]){
      markers[s.id].setIcon(makeIcon(s));
    } else {
      const m=L.marker([s.lat,s.lng],{icon:makeIcon(s),riseOnHover:true});
      m.on('click',()=>selectShop(s.id));
      m.addTo(leafMap);
      markers[s.id]=m;
    }
  });
}

// ‚îÄ‚îÄ SELECT / DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectShop(id){
  selectedId=id;
  const s=shops.find(x=>x.id===id);
  if(!s) return;
  if(s.lat!=null) leafMap.flyTo([s.lat,s.lng],Math.max(leafMap.getZoom(),15),{duration:0.7});
  render();
  openDetail(s);
}

function openDetail(s){
  const cfg=CHANNELS[s.channel]||{color:'#999'};
  document.getElementById('detail-name').textContent=s.name;
  document.getElementById('detail-panel').classList.add('open');
  const typeLabel={retail:'‡∏õ‡∏•‡∏µ‡∏Å',wholesale:'‡∏™‡πà‡∏á',horeca:'HoReCa'}[s.type]||s.type;
  document.getElementById('detail-body').innerHTML=`
    <div class="detail-field"><label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><span class="ch-badge" style="background:${cfg.color};display:inline-block">${s.channel}</span></div>
    <div class="detail-field"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><p>${typeLabel}</p></div>
    ${s.address?`<div class="detail-field"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><p>${s.address}</p></div>`:''}
    ${s.phone?`<div class="detail-field"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label><p>${s.phone}</p></div>`:''}
    <div class="detail-field"><label>‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
      <div class="products-list">${(s.products||[]).map(p=>`<span class="product-tag">${p}</span>`).join('')||'‚Äî'}</div>
    </div>
    <div class="detail-field"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à</label><p>${s.rating?'‚≠ê'.repeat(s.rating)+` (${s.rating}/5)`:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'}</p></div>
    ${s.note?`<div class="detail-field"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><p>${s.note}</p></div>`:''}
    ${s.lat!=null?`<div class="detail-field"><label>‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</label>
      <p style="font-family:'Space Mono',monospace;font-size:11px">${s.lat.toFixed(5)}, ${s.lng.toFixed(5)}</p>
      <a href="https://maps.google.com/?q=${s.lat},${s.lng}" target="_blank" style="font-size:12px;color:var(--accent)">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps ‚Üó</a>
    </div>`:''}
    <div class="detail-field"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Pin</label>
      <button class="btn ${s.pinned?'btn-danger':'btn-ghost'}" style="height:28px;font-size:12px" onclick="togglePin('${s.id}')">
        ${s.pinned?'üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà ‚Äî ‡∏ñ‡∏≠‡∏î‡∏≠‡∏≠‡∏Å':'üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î'}
      </button>
    </div>`;
  setTimeout(()=>leafMap.invalidateSize(),260);
}

function closeDetail(){
  document.getElementById('detail-panel').classList.remove('open');
  selectedId=null; render();
  setTimeout(()=>leafMap.invalidateSize(),260);
}
function togglePin(id){const s=shops.find(x=>x.id===id);if(s){s.pinned=!s.pinned;save();render();openDetail(s);}}
function editCurrent(){if(selectedId)openForm(selectedId);}
let _confirmCallback=null;
function showConfirm(msg, cb){
  document.getElementById('confirm-msg').textContent=msg;
  document.getElementById('confirm-overlay').classList.add('show');
  _confirmCallback=cb;
}
function confirmOk(){
  document.getElementById('confirm-overlay').classList.remove('show');
  if(_confirmCallback){ _confirmCallback(); _confirmCallback=null; }
}
function confirmClose(){
  document.getElementById('confirm-overlay').classList.remove('show');
  _confirmCallback=null;
}
function deleteCurrent(){
  if(!selectedId) return;
  const s=shops.find(x=>x.id===selectedId);
  const name=s?s.name:'‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ';
  showConfirm(`‡∏•‡∏ö "${name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà?`, ()=>{
    if(markers[selectedId]){leafMap.removeLayer(markers[selectedId]);delete markers[selectedId];}
    shops=shops.filter(s=>s.id!==selectedId);
    selectedId=null; save(); closeDetail(); render();
    showToast('‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
  });
}

// ‚îÄ‚îÄ PICK MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startPick(){
  pickMode=true;
  window._pickCoords=null;
  // Slide the form away WITHOUT calling closeForm() ‚Äî that would reset pickMode
  document.getElementById('form-overlay').classList.remove('open');
  document.getElementById('form-drawer').classList.remove('open');
  // Activate pick mode UI
  document.getElementById('pick-banner').classList.add('active');
  document.getElementById('map').classList.add('pick-mode');
  const lc=document.querySelector('.leaflet-container');
  if(lc){ lc.style.setProperty('cursor','crosshair','important'); }
}
function cancelPick(){
  pickMode=false;
  document.getElementById('pick-banner').classList.remove('active');
  document.getElementById('map').classList.remove('pick-mode');
  const lc=document.querySelector('.leaflet-container');
  if(lc) lc.style.removeProperty('cursor');
  openForm(editId);
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildChannelFilters(){
  document.getElementById('channel-filters').innerHTML=Object.entries(CHANNELS).map(([ch,cfg])=>`
    <label class="filter-item">
      <input type="checkbox" checked onchange="toggleChannelFilter('${ch}',this.checked)">
      <span class="ch-dot" style="background:${cfg.color}"></span>
      <span>${ch}</span>
      <span class="filter-count" id="fc-${ch.replace(/[^\w]/g,'_')}">0</span>
    </label>`).join('');
}
function buildProductFilters(){
  document.getElementById('product-filters').innerHTML=PRODUCTS.map(p=>`
    <label class="filter-item">
      <input type="checkbox" checked onchange="toggleProductFilter('${p}',this.checked)">
      <span>${p}</span>
    </label>`).join('');
}
function buildLegend(){
  document.getElementById('legend-rows').innerHTML=Object.entries(CHANNELS).map(([ch,cfg])=>
    `<div class="legend-row"><span class="ch-dot" style="background:${cfg.color}"></span>${cfg.icon} ${ch}</div>`).join('');
}
function toggleChannelFilter(ch,on){if(on)filters.channels.add(ch);else filters.channels.delete(ch);render();}
function toggleProductFilter(p,on){if(on)filters.products.add(p);else filters.products.delete(p);render();}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildProductCheckboxes(){
  document.getElementById('product-checkboxes').innerHTML=PRODUCTS.map(p=>`
    <label class="cb-item"><input type="checkbox" value="${p}" name="products">${p}</label>`).join('');
}
function buildRatingStars(){
  document.getElementById('rating-stars').innerHTML=[1,2,3,4,5].map(i=>`<span class="star" data-v="${i}" onclick="setRating(${i})">‚òÖ</span>`).join('');
}
function setRating(v){
  rating=v;
  document.querySelectorAll('.star').forEach(s=>s.classList.toggle('on',+s.dataset.v<=v));
  document.getElementById('rating-label').textContent=['','‡πÅ‡∏¢‡πà','‡∏û‡∏≠‡πÉ‡∏ä‡πâ','‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á','‡∏î‡∏µ','‡∏î‡∏µ‡∏°‡∏≤‡∏Å'][v]||'';
}

function openForm(id=null){
  editId=id;
  const s=id?shops.find(x=>x.id===id):null;
  document.getElementById('form-title').textContent=s?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤':'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
  document.getElementById('f-name').value=s?.name||'';
  document.getElementById('f-channel').value=s?.channel||'';
  document.getElementById('f-type').value=s?.type||'retail';
  document.getElementById('f-address').value=s?.address||'';
  document.getElementById('f-phone').value=s?.phone||'';
  document.getElementById('f-note').value=s?.note||'';
  document.querySelectorAll('#product-checkboxes input').forEach(cb=>cb.checked=s?.products?.includes(cb.value)||false);
  rating=s?.rating||0; setRating(rating);
  if(s?.lat!=null){
    window._pickCoords={lat:s.lat,lng:s.lng};
    document.getElementById('coords-display').style.display='block';
    document.getElementById('coords-display').textContent=`${s.lat.toFixed(6)}, ${s.lng.toFixed(6)}`;
  } else {
    window._pickCoords=null;
    document.getElementById('coords-display').style.display='none';
  }
  document.getElementById('form-overlay').classList.add('open');
  document.getElementById('form-drawer').classList.add('open');
  setTimeout(()=>document.getElementById('f-name').focus(),250);
}
function closeForm(){
  document.getElementById('form-overlay').classList.remove('open');
  document.getElementById('form-drawer').classList.remove('open');
  editId=null;
  // Only reset pick mode if we're not actively picking
  if(!pickMode){
    document.getElementById('pick-banner').classList.remove('active');
    document.getElementById('map').classList.remove('pick-mode');
    const lc=document.querySelector('.leaflet-container');
    if(lc) lc.style.removeProperty('cursor');
  }
}
function saveShop(){
  const name=document.getElementById('f-name').value.trim();
  const channel=document.getElementById('f-channel').value;
  if(!name){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');return;}
  if(!channel){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á');return;}
  const products=[...document.querySelectorAll('#product-checkboxes input:checked')].map(cb=>cb.value);
  const coords=window._pickCoords;
  const ctr=leafMap.getCenter();
  const shopData={
    name,channel,
    type:document.getElementById('f-type').value,
    address:document.getElementById('f-address').value.trim(),
    phone:document.getElementById('f-phone').value.trim(),
    products,rating,
    note:document.getElementById('f-note').value.trim(),
    lat:coords?coords.lat:(ctr.lat+(Math.random()-.5)*0.003),
    lng:coords?coords.lng:(ctr.lng+(Math.random()-.5)*0.003),
  };
  if(editId){
    const idx=shops.findIndex(s=>s.id===editId);
    if(idx>=0){shops[idx]={...shops[idx],...shopData};if(markers[editId])markers[editId].setLatLng([shopData.lat,shopData.lng]);}
  } else {
    shopData.id=Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    shopData.pinned=false;
    shops.push(shopData);
  }
  save(); closeForm(); render();
  showToast(editId?'‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ':'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('search').addEventListener('input',function(){
  const q=this.value.trim().toLowerCase();
  const dd=document.getElementById('search-dropdown');
  if(!q){dd.classList.remove('show');render();return;}
  render();
  const results=shops.filter(s=>s.name.toLowerCase().includes(q)||(s.address||'').toLowerCase().includes(q)).slice(0,6);
  if(!results.length){dd.classList.remove('show');return;}
  dd.innerHTML=results.map(r=>{
    const cfg=CHANNELS[r.channel]||{color:'#999'};
    return `<div class="drop-item" onclick="selectShop('${r.id}');document.getElementById('search').value='';document.getElementById('search-dropdown').classList.remove('show')">
      <span class="drop-ch" style="background:${cfg.color}"></span><span>${r.name}</span>
      <span style="margin-left:auto;font-size:11px;color:var(--t3)">${r.channel}</span>
    </div>`;
  }).join('');
  dd.classList.add('show');
});
document.addEventListener('click',e=>{if(!e.target.closest('#search-wrap'))document.getElementById('search-dropdown').classList.remove('show');});

// ‚îÄ‚îÄ IMPORT/EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV(){
  const header='id,name,channel,type,address,phone,products,rating,note,lat,lng,pinned';
  const rows=shops.map(s=>[
    s.id,`"${s.name}"`,s.channel,s.type||'retail',`"${s.address||''}"`,s.phone||'',
    `"${(s.products||[]).join('|')}"`,s.rating||0,`"${s.note||''}"`,
    s.lat!=null?s.lat:'',s.lng!=null?s.lng:'',s.pinned?1:0
  ].join(','));
  const csv=[header,...rows].join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`cpf_shops_kpp_${new Date().toISOString().slice(0,10)}.csv`;a.click();
  showToast('Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üì•');
}
function importCSV(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const lines=ev.target.result.replace(/\r/g,'').split('\n');
    const headers=lines[0].split(',');let imported=0;
    for(let i=1;i<lines.length;i++){
      if(!lines[i].trim())continue;
      const vals=lines[i].match(/(".*?"|[^,]+)/g)||[];
      const clean=v=>(v||'').replace(/^"|"$/g,'').trim();
      const row={};headers.forEach((h,j)=>row[h.trim()]=clean(vals[j]||''));
      if(!row.name||!row.channel)continue;
      const existing=shops.findIndex(s=>s.id===row.id);
      const shop={id:row.id||Date.now().toString(36)+i,name:row.name,channel:row.channel,type:row.type||'retail',
        address:row.address||'',phone:row.phone||'',products:row.products?row.products.split('|').filter(Boolean):[],
        rating:+row.rating||0,note:row.note||'',lat:row.lat?+row.lat:null,lng:row.lng?+row.lng:null,pinned:row.pinned==='1'};
      if(existing>=0){if(markers[shop.id]){leafMap.removeLayer(markers[shop.id]);delete markers[shop.id];}shops[existing]=shop;}
      else{shops.push(shop);imported++;}
    }
    save();render();showToast(`Import ${imported} ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‚úÖ`);
  };
  reader.readAsText(file,'utf-8');e.target.value='';
}

// ‚îÄ‚îÄ SHARE/UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shareApp(){
  const url=window.location.href;
  if(navigator.share){navigator.share({title:'CPF Market Map ‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£',url}).catch(()=>{});}
  else{navigator.clipboard.writeText(url).then(()=>showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß üìã')).catch(()=>prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ô‡∏µ‡πâ:',url));}
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('collapsed');setTimeout(()=>leafMap.invalidateSize(),260);}
function showToast(msg,dur=2800){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init(){
  initMap();
  await load();
  buildChannelFilters();buildProductFilters();buildLegend();
  buildProductCheckboxes();buildRatingStars();
  render();
}
init();
</script>
</body>
</html>
